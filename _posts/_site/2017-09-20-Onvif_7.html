<blockquote>
  <p>The imaging service provides configuration and control data for imaging specific properties.<br />
WSDL is part of the framework and provided in the Imaging WSDL file.<br />
The service includes the following operations:<br />
    Get and set imaging configurations (exposure time, gain and white balance, for example). <br />
    Get imaging configuration options (valid ranges for imaging parameters).<br />
    Move focus lens including position and move status retrieval. <br />
    Imaging Presets</p>
</blockquote>

<p><code class="highlighter-rouge">image(timg)</code>实际上是配置媒体源,配置对应的源时应该拿属于它的<code class="highlighter-rouge">SourceToken</code>.<br />
服务的地址可以从<code class="highlighter-rouge">Device(tds)</code>的<code class="highlighter-rouge">getService(s)</code>或<code class="highlighter-rouge">getCapability(ies)</code>拿到,<br />
媒体源可以从<code class="highlighter-rouge">Media(trt或ns8)</code>中<code class="highlighter-rouge">getVideosSource(s)</code>的获取,或存储在<code class="highlighter-rouge">profile</code>中的<code class="highlighter-rouge">SourceToken</code>字段<br />
各大服务是相对独立的(<code class="highlighter-rouge">无关性</code>),<br />
假设你从其他渠道获拿到SourceToken,和image服务地址
便可以不通过device和media直接对image部分进行操作;</p>
<ul>
  <li>
    <p>亮度,对比度,背光,白平衡,夜间模式</p>
  </li>
  <li>
    <p>focus presets 等</p>
  </li>
</ul>

<p>获取图像配置</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">getImageSetting</span><span class="p">(</span><span class="k">struct</span> <span class="n">soap</span><span class="o">*</span> <span class="n">soap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_trt__GetVideoSourcesResponse</span> <span class="o">*</span><span class="n">getVideosourcesResp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_trt__GetProfilesResponse</span> <span class="o">*</span><span class="n">profiles</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">image_ep</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">_timg__GetImagingSettings</span> <span class="o">*</span><span class="n">getImageReq</span>
            <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_timg__GetImagingSettings</span> <span class="o">*</span><span class="p">)</span><span class="n">soap_malloc</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_timg__GetImagingSettings</span><span class="p">));</span>
    <span class="n">soap_default__timg__GetImagingSettings</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">getImageReq</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">_timg__GetImagingSettingsResponse</span> <span class="o">*</span><span class="n">getImageResp</span>
            <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_timg__GetImagingSettingsResponse</span> <span class="o">*</span><span class="p">)</span><span class="n">soap_malloc</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_timg__GetImagingSettingsResponse</span><span class="p">));</span>
    <span class="n">soap_default__timg__GetImagingSettingsResponse</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">getImageResp</span><span class="p">);</span>

    <span class="n">getImageReq</span><span class="o">-&gt;</span><span class="n">VideoSourceToken</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">-&gt;</span><span class="n">Profiles</span><span class="o">-&gt;</span><span class="n">VideoSourceConfiguration</span><span class="o">-&gt;</span><span class="n">SourceToken</span><span class="p">;</span>

    <span class="n">soap_wsse_add_UsernameTokenDigest</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span><span class="s">"user"</span><span class="p">,</span> <span class="n">ONVIF_USER</span><span class="p">,</span> <span class="n">ONVIF_PASSWORD</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">soap_call___timg__GetImagingSettings</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">image_ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">getImageReq</span><span class="p">,</span> <span class="n">getImageResp</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">SOAP_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[brightness:%f]</span><span class="se">\n</span><span class="s">[contrast:%f]</span><span class="se">\n</span><span class="s">[colorsaturation:%f]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">getImageResp</span><span class="o">-&gt;</span><span class="n">ImagingSettings</span><span class="o">-&gt;</span><span class="n">Brightness</span>
           <span class="p">,</span> <span class="o">*</span><span class="n">getImageResp</span><span class="o">-&gt;</span><span class="n">ImagingSettings</span><span class="o">-&gt;</span><span class="n">Contrast</span><span class="p">,</span> <span class="o">*</span><span class="n">getImageResp</span><span class="o">-&gt;</span><span class="n">ImagingSettings</span><span class="o">-&gt;</span><span class="n">ColorSaturation</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>设置图像配置</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">setImageSetting</span><span class="p">(</span><span class="k">struct</span> <span class="n">soap</span><span class="o">*</span> <span class="n">soap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_trt__GetVideoSourcesResponse</span> <span class="o">*</span><span class="n">getVideosourcesResp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_trt__GetProfilesResponse</span> <span class="o">*</span><span class="n">profiles</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">image_ep</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">_timg__SetImagingSettings</span> <span class="o">*</span><span class="n">setImageReq</span>
            <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_timg__SetImagingSettings</span> <span class="o">*</span><span class="p">)</span><span class="n">soap_malloc</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_timg__SetImagingSettings</span><span class="p">));</span>
    <span class="n">soap_default__timg__SetImagingSettings</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">setImageReq</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">_timg__SetImagingSettingsResponse</span> <span class="o">*</span><span class="n">setImageResp</span>
            <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_timg__SetImagingSettingsResponse</span> <span class="o">*</span><span class="p">)</span><span class="n">soap_malloc</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_timg__SetImagingSettingsResponse</span><span class="p">));</span>
    <span class="n">soap_default__timg__SetImagingSettingsResponse</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">setImageResp</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">tt__ImagingSettings20</span> <span class="o">*</span><span class="n">imagesetting</span>
            <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tt__ImagingSettings20</span><span class="o">*</span><span class="p">)</span><span class="n">soap_malloc</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tt__ImagingSettings20</span><span class="p">));</span>

    <span class="n">setImageReq</span><span class="o">-&gt;</span><span class="n">VideoSourceToken</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">-&gt;</span><span class="n">Profiles</span><span class="o">-&gt;</span><span class="n">VideoSourceConfiguration</span><span class="o">-&gt;</span><span class="n">SourceToken</span><span class="p">;</span>
    <span class="n">setImageReq</span><span class="o">-&gt;</span><span class="n">ForcePersistence</span> <span class="o">=</span> <span class="n">xsd__boolean__false_</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">33</span><span class="p">.</span><span class="mi">33</span><span class="p">;</span>
    <span class="n">imagesetting</span><span class="o">-&gt;</span><span class="n">Brightness</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
    <span class="n">imagesetting</span><span class="o">-&gt;</span><span class="n">ColorSaturation</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
    <span class="n">imagesetting</span><span class="o">-&gt;</span><span class="n">Contrast</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>

    <span class="n">setImageReq</span><span class="o">-&gt;</span><span class="n">ImagingSettings</span> <span class="o">=</span> <span class="n">imagesetting</span><span class="p">;</span>

    <span class="n">soap_wsse_add_UsernameTokenDigest</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span><span class="s">"user"</span><span class="p">,</span> <span class="n">ONVIF_USER</span><span class="p">,</span> <span class="n">ONVIF_PASSWORD</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">soap_call___timg__SetImagingSettings</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">image_ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">setImageReq</span><span class="p">,</span> <span class="n">setImageResp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">image</code>服务的<code class="highlighter-rouge">Extension</code>字段较多,意味着各厂商服务端的实现不能是高度一致的<br />
所以从这里开始,你要对你的设备更加的熟悉了,<br />
假如某些<code class="highlighter-rouge">extension</code>如果有不太明确的地方:<br />
可以尝试使用设备提供的SDK先验证一下功能,在对应的来写ONVIF实现. <br />
<big><big><big>
<a href="https://www.onvif.org/ver20/imaging/wsdl/imaging.wsdl">ImageBindin</a><br />
<a href="https://www.onvif.org/specs/srv/img/ONVIF-Imaging-Service-Spec-v1706.pdf">文档</a><br />
</big></big></big></p>
