<blockquote>
  <p>坐标转换过程中,一定要保持精度..</p>
</blockquote>

<p><big><big><big>我们继续来搞OSD</big></big></big></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The OSD  service provides functions to enable a client to control and configure On-Screen Display of a device.   
The service introduces the OSD configuration with multiple types (e.g., image, text, date,  and time).    
Also functions to retrieve and configure the configurations are provided.   
All OSD configurations are related to a VideoSourceConfiguration which will display the content of OSD.
</code></pre></div></div>

<p>两点比较需要明确:</p>
<ol>
  <li>所有OSD的配置都跟<code class="highlighter-rouge">VideoSourceConfiguration</code>有关,<br />
即OSD是在视频源上添加,你有几路视频源,就可以设置几套OSD方案,与profile一样,通过<code class="highlighter-rouge">Sourcetoken</code>找到;<br />
另外在同源中OSD是可以叠加N个的(N通过getOSDOption查看)<br />
操作某一层OSD,需要<code class="highlighter-rouge">OSDToken</code>;
所以OSD相关参数要求的token,就不全是<code class="highlighter-rouge">ProfileToken</code>也会有<code class="highlighter-rouge">SourceToken</code>和<code class="highlighter-rouge">OSDToken</code>.(MediaBindin)<br />
当你需要修改特定配置时<code class="highlighter-rouge">(这里是应该获取的token)</code>
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> `-- Device
     `-- Media(MediaProfile_1)
         `-- VideoSource(VideoSource_1)
           |   `-- OSDPlanText(OSD_1)
           |       `--fontSize
           |       `--fontcolor
           |   `-- OSDDateTime(OSD_2)
           |       `-- datefmt
           |       `-- timefmt           
           |   `-- ...(OSD_X)                   
</code></pre></div>    </div>
    <p><big><strong>我要修改<code class="highlighter-rouge">主码流</code>的<code class="highlighter-rouge">显示的日期格式</code>时需要拿到的<code class="highlighter-rouge">token</code><br />
  就是:<code class="highlighter-rouge">VideoSource_1</code>&amp;<code class="highlighter-rouge">OSD_2</code>;</strong></big></p>
  </li>
  <li>OSD的种类
    <ul>
      <li>image-Logo
        <ul>
          <li>只看没用过,没有发言权</li>
        </ul>
      </li>
      <li>text-文字
        <ul>
          <li>可以修改字体(跨平台的慎重)
            <ul>
              <li>确保摄像机支持,操作系统支持等等,大小,颜色等等<br />
 类型如:
                <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">struct</span> <span class="n">tt__OSDColor</span> <span class="n">fontcolor</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">tt__OSDColor</span> <span class="n">backgroundcolor</span><span class="p">;</span>
  <span class="kt">int</span><span class="o">*</span> <span class="n">fontSize</span><span class="p">;</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>Soap消息中文的问题
            <ul>
              <li>Linux下soap默认utf-8编码,但是我的onvif客户端插件会被Linux服务加载并发送到对端的windows/Linux/移动端/嵌入式设备<br />
 如果是非soap部分可以用iconv或boost::locale</li>
              <li>与摄像机通信部分<br />
  大多采用的是调用
                <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">soap_set_mode</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">SOAP_C_UTFSTRING</span><span class="p">);</span>
</code></pre></div>                </div>
                <p>而我直接初始化SOAP时用第二种方式申请内存</p>
                <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m_soap</span> <span class="o">=</span> <span class="n">soap_new2</span><span class="p">(</span><span class="n">SOAP_C_UTFSTRING</span><span class="p">,</span> <span class="n">SOAP_C_UTFSTRING</span><span class="p">);</span>
</code></pre></div>                </div>
                <p>用来确保inputMode和outputMode均为SOAP_C_UTFSTRING</p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>date-日期和time-时间
        <ul>
          <li>某些设备的某个OSD类型为<code class="highlighter-rouge">DateAndTime</code>(<strong>有且仅有1</strong>)<br />
  该<code class="highlighter-rouge">VideoSource</code>下不允许出现其他date和time
            <ul>
              <li><strong>有些不严格按照规范写服务的厂商,都要以<code class="highlighter-rouge">option</code>回复为准</strong></li>
            </ul>
          </li>
          <li>可以修改格式如:
            <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">datefmt</span> <span class="o">=</span> <span class="s">"MM/dd/yyyy"</span><span class="p">;</span>
  <span class="n">timefmt</span> <span class="o">=</span> <span class="s">"HH:mm:ss"</span><span class="p">;</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>extension(比如我的hik-SDI-2010DN)
        <ul>
          <li><code class="highlighter-rouge">&lt;tt:Extension&gt;&lt;channl&gt;Camera 01..</code><br />
  这是默认的一层OSD实际是text类型(<code class="highlighter-rouge">Plain</code>)创建时可覆盖,删改操作都是可以的.</li>
        </ul>
      </li>
    </ul>

    <blockquote>
      <p><code class="highlighter-rouge">tips</code>这里提供复合模式(date&amp;星期&amp;time)等多种组合</p>
    </blockquote>
  </li>
</ol>

<p><big><big><big>我们先来看一下OSD的坐标系统</big></big></big>
<img src="https://github.com/halukasama/imghosting/blob/1cf07f480d9aaf7ccbf33a2a45dbe2b78833b234/onvif/4/onvif_5coordinate.png?raw=true" alt="onvif_Osdcoor" /></p>

<p>相对坐标,而不是对应屏幕的绝对坐标,垂直和水平的range都是±1,<br />
坐上-1,1 右上1,1,左下-1,-1,右上1,-1;中心点0,0;</p>

<p><big><big><big><big><strong>DEMO</strong></big></big></big></big></p>

<p><big><big>获取OSDS</big></big></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void getOsds(struct soap* soap , char* ep, struct _trt__GetProfilesResponse *trt__GetProfilesResponse, struct _trt__GetOSDs *trt__GetOSDs, struct _trt__GetOSDsResponse *trt__GetOSDsResponse)
{
    trt__GetOSDs-&gt;ConfigurationToken = trt__GetProfilesResponse-&gt;Profiles-&gt;VideoSourceConfiguration-&gt;token;
    printf("[%d][---- start get osdconfig ----]\n", __LINE__);
    soap_wsse_add_UsernameTokenDigest(soap, "user", ONVIF_USER, ONVIF_PASSWORD);
    int result = soap_call___trt__GetOSDs(soap, ep, NULL, trt__GetOSDs, trt__GetOSDsResponse);
    printf("errorNo: %d\n",result);
    return;
}
</code></pre></div></div>

<p><big><big><big>创建时间日期OSD</big></big></big></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void CreateDataTimeOsd(struct soap*soap, char*ep, struct _trt__CreateOSD *req, struct _trt__CreateOSDResponse *resp, struct _trt__GetOSDsResponse *osdcfg)
{
    struct tt__OSDConfiguration osd;
    char* token = "";//"OsdToken_101";
    struct tt__OSDReference reftoken;
    osd.token = token;
    reftoken.__item = "VideoSourceToken";
    reftoken.__anyAttribute = NULL;
    osd.VideoSourceConfigurationToken = &amp;reftoken;
    osd.Type = tt__OSDType__Text;
    osd.__anyAttribute = NULL;

    struct tt__OSDPosConfiguration pos;
    char *postype = "Custom";
    pos.Type = postype;
    float x = -0.95;
    float y = 0.8;
    struct tt__Vector coor;
    coor.x = &amp;x;
    coor.y = &amp;y;
    pos.Pos = &amp;coor;
    struct tt__OSDPosConfigurationExtension posextension;
    posextension.__any = "";
    posextension.__size = 8;
    posextension.__anyAttribute = "";
    pos.__anyAttribute = "";
    pos.Extension = &amp;posextension;
    struct tt__OSDTextConfiguration textstr;
    struct tt__OSDColor fontcolor;
    struct tt__OSDColor backgroundcolor;
    struct tt__OSDTextConfigurationExtension textstrExtension;
    textstrExtension.__any = "";
    textstrExtension.__size = 1;
    textstrExtension.__anyAttribute = "";

    struct tt__Color color;
    //&lt;tt:Color X="16.000000" Y="128.000000" Z="128.000000"
        //Colorspace="http://www.onvif.org/ver10/colorspace/YCbCr"
    color.X = 16;
    color.Y = 128;
    color.Z = 128;
    color.Colorspace = "http://www.onvif.org/ver10/colorspace/YCbCr";
    fontcolor.Color = &amp;color;
    int transparent = 0;
    fontcolor.Transparent = &amp;transparent;
    fontcolor.__anyAttribute = "";

    backgroundcolor.Color = &amp;color;
    backgroundcolor.Transparent = &amp;transparent;
    backgroundcolor.__anyAttribute = "";
    textstr.Extension = &amp;textstrExtension;
    textstr.FontColor = &amp;fontcolor;
    textstr.BackgroundColor = &amp;backgroundcolor;

    char *strtype = "DateAndTime";
    int fontsize = 64;
    int *FontSize = &amp;fontsize;
    char *datefmt = "yyyy/MM/dd";
    char *timefmt = "HH:mm:ss";
    textstr.Type = strtype;
    textstr.FontSize = FontSize;
    textstr.DateFormat = datefmt;
    textstr.TimeFormat = timefmt;
    textstr.__anyAttribute = "";
    osd.Extension = NULL;// osdcfg-&gt;OSDs-&gt;Extension;
    osd.Image = NULL;//osdcfg-&gt;OSDs-&gt;Image;
    osd.TextString = &amp;textstr;
    osd.Position = &amp;pos;

    struct tt__OSDConfigurationExtension extension;
    extension.__any = "";
    extension.__size = 0;
    extension.__anyAttribute = "";
    osd.Extension = &amp;extension;
    req-&gt;OSD = &amp;osd;
    soap_wsse_add_UsernameTokenDigest(soap, "user", ONVIF_USER, ONVIF_PASSWORD);
    soap_call___trt__CreateOSD(soap, ep, NULL, req, resp);
    printf("float_format ????  %   \n", soap-&gt;float_format);
    ....
}
</code></pre></div></div>
<p><big><big><big>删除时间日期OSD</big></big></big></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void deleteDatetimeOsd(struct soap* soap, char* ep, struct _trt__DeleteOSD *req, struct _trt__DeleteOSDResponse *resp)
{
    char *token = "OsdToken_101";
    req-&gt;OSDToken = token;
    soap_wsse_add_UsernameTokenDigest(soap, "user", ONVIF_USER, ONVIF_PASSWORD);
    soap_call___trt__DeleteOSD(soap, ep, NULL, req, resp);
}
</code></pre></div></div>
<p><big><big><big>修改字幕</big></big></big></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void SetOsd(struct soap*soap, char*ep, struct _trt__SetOSD *req, struct _trt__SetOSDResponse *resp, struct _trt__GetOSDsResponse *osdcfg)
{
    struct tt__OSDConfiguration osd;
    char *text = "支持中文abc";
    osdcfg-&gt;OSDs[1].TextString-&gt;PlainText = text;
#if 0
    int i;
    for (i = 0; i &lt;= osdcfg-&gt;__sizeOSDs; i++) {
        if (!strcmp(osdcfg-&gt;OSDs[i].token,token)) {
            printf("it's plaintext\n");
            osdcfg-&gt;OSDs-&gt;TextString-&gt;PlainText = text;
            printf("val ready\n");
        }
    }
#endif
    osd = osdcfg-&gt;OSDs[1];
    req-&gt;OSD = &amp;osd;
    printf("ready to send request......\n");
    soap_wsse_add_UsernameTokenDigest(soap, "user", ONVIF_USER, ONVIF_PASSWORD);
    soap_call___trt__SetOSD(soap, ep, NULL, req, resp);
    ....
    ....

</code></pre></div></div>

<p><big><big><big>阅读<a href="https://www.onvif.org/ver10/media/wsdl/media.wsdl">MediaBindin</a><br />
接口<code class="highlighter-rouge">Description</code><br />
参数<code class="highlighter-rouge">Input</code><br />
返回值<code class="highlighter-rouge">Output</code><br />
</big></big></big></p>
